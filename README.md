# Bird Gallery

A gallery of birds I have seen.

Deployed to https://birds.xaviershay.com

`src/ts/routes.ts` is the primary entry point.

## History & Motivation

I track my sightings using eBird, and upload photos to associated Macualey
library, but want to both host my own data and display how I like it, as well as
run extra analyses not provided by eBird. An initial attempt used the same
micro-framework as [my blog](https://github.com/xaviershay/blog-v2) to generate
a static site. As the number of pages grew (about 1000 at time of writing) it
felt time to switch to dynamic generation.

### Design goals and constraints

- Server from `xaviershay.com` domain.
- Handle daily or weekly updates (not hourly.)
- Minimal dependencies, and stable ones where necessary. I don't have
  many feature needs. Optimize for maximum hackability with limited scope for
  breaking changes I don't control.
- Stick to cloud providers I already use (Cloudflare or AWS).
- Experiment with serverless.
- Allow _some_ novelty for learning purposes.

I decided to use [Cloudflare Workers](https://workers.cloudflare.com/) with [D1
to provide a distributed read-only SQLite
database,](https://developers.cloudflare.com/d1/) and [R2 object
storage](https://www.cloudflare.com/developer-platform/products/r2/) for photos.

While Workers support any WebAssembly language, using Ruby (my normal language)
felt too unusual in this setting. TypeScript is both well-supported and a
language I need to learn better. I also like JSX for HTML generation.

The approach this led to:

- Manually export eBird data to CSV and store in the repository (`data/csv`). This process could be automated in the future though is clunky: requires web scraping (and raw credentials!) to request the export, then email monitoring to wait for the results.
- Copy tagged and processed photos locally. Extract metadata and store that in repository (`data/metadata`). Generate thumbnails, then sync both those and full size images to R2 bucket.
- Generate SQL statements from both sources of data to populate a SQLite database.
- A Cloudflare Worker processes requests by querying SQLite.

### Dependencies

- **Cloudflare** for serverless execution, database, and object storage.
- **React DOM Server** for JSX and HTML generation.
- **Mapbox** for maps. I may try and decouple from them in the future, but they
  are a relatively stable provider.
- **Exifr** for extracting metadata from photos.
- **date-fns** for date parsing and formatting.
- **csv-parse** for CSV parsing.

### Cute Things

The page background (`src/svg/composited.svg`) is generated by randomly
compositing a number of free bird SVGs [(courtesy of
Freepik)](https://www.freepik.com/free-vector/birds-silhouettes-collection_907524.htm)
onto a larger canvas. See `bin/generate-background`.

Responses are stored in Cloudflare's Cache API so they only need to be generated
once. A cache-busting version key is updated every deployment or data change.

## Deploy

Site is available at https://birds.xaviershay.com

    export CLOUDFLARE_API_TOKEN=secret

    bin/deploy           # Push latest code and data

    # Database
    npx wrangler d1 execute birds --remote --file=src/sql/schema.sql
    bin/load-data-remote

    # Sync data/photos
    bin/generate-thumbnails
    bin/extract-photo-metadata
    bin/sync-photos

## TODO

- Clean up controller/model split
- Figure out why page takes 100ms (prob database? Have done 0 optimisation.)
- Terraform for birds{,-gallery}.xaviershay.com and SSL cert
- Photo "needs" list
- Monitoring of common locations?
- Fixed width/height tags for photos

### eBird API wants

Keeping track of frustrations I've had with eBird.

- Exotic flags not in exported observation data (example:
  https://ebird.org/checklist/S220837850). _Use case:_ my own list calculations
  can match that of eBird. (I've hard coded an exception for these birds in this code base.)
- JSON API for download observations rather than request emailed file. _Use
  case:_ easier to refresh my own calculations/dashboard.
- Ability to fetch lists of other users' (where displayed publicly). _Use case:_
- build some social features with my friends, e.g. "which bird have I seen that
  you haven't? I can show you" or "which bird in a region have neither of us
  seen"
